<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Roll Playing</title>
    {% block styles %}
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #2c3e50;
        color: #e8e8e8;
      }

      .chat-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      .chatheader {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background-color: #34495e;
        padding: 10px 20px;
        text-align: center;
        z-index: 10;
      }

      .chatbody {
        flex-grow: 1;
        margin-top: 60px; /* í—¤ë” ë†’ì´ë§Œí¼ ì•„ë˜ë¡œ ë°€ì–´ì¤Œ */
        margin-bottom: 60px; /* í‘¸í„° ë†’ì´ë§Œí¼ ìœ„ë¡œ ë°€ì–´ì¤Œ */
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .chatfooter {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #34495e;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        z-index: 10;
      }

      .message {
        background-color: #1abc9c;
        padding: 10px;
        border-radius: 10px;
        max-width: 70%;
        word-wrap: break-word;
        display: inline-block;
        margin-bottom: 10px;
      }

      .message.sent {
        background-color: #2980b9;
        align-self: flex-end; /* ì˜¤ë¥¸ìª½ ì •ë ¬ */
      }

      .message.received {
        background-color: #1abc9c;
        align-self: flex-start; /* ì™¼ìª½ ì •ë ¬ */
      }

      .input-box {
        width: 80%;
        padding: 10px;
        border: none;
        border-radius: 5px;
        background-color: #34495e;
        color: #e8e8e8;
        font-size: 16px;
      }

      .input-box:focus {
        outline: none;
        border: 1px solid #1abc9c;
      }

      .send-button,
      .voice-button {
        background-color: #1abc9c;
        border: none;
        padding: 10px;
        border-radius: 5px;
        color: white;
        cursor: pointer;
        font-size: 16px;
        margin-left: 10px;
      }
      .send-button:hover,
      .voice-button:hover {
        background-color: #16a085;
      }
    </style>
    {% endblock %}
  </head>
  <body>
    <div class="chat-container">
      <div class="chatheader">Roll Playing Chat</div>
      {% if user.is_authenticated %}
      <div class="chatbody" id="chatBody">
        <!-- ë°›ì€ ë©”ì‹œì§€ (ì™¼ìª½) -->
        <div class="message received">
          ì•ˆë…•í•˜ì„¸ìš” ì˜ë“±í¬ê²½ì°°ì²­ ë°•ê±°ëŸ‰í˜•ì‚¬ì…ë‹ˆë‹¤.!!
        </div>
        <!-- ë³´ë‚¸ ë©”ì‹œì§€ (ì˜¤ë¥¸ìª½) -->
        <div class="message sent"></div>
        <!-- ì±„íŒ… ë©”ì‹œì§€ê°€ ë™ì ìœ¼ë¡œ ì—¬ê¸°ì— ì¶”ê°€ë  ê²ƒì…ë‹ˆë‹¤ -->
      </div>
      <div class="chatfooter">
        <input
          class="input-box"
          type="text"
          placeholder="Type a message..."
          id="messageInput"
        />
        <button class="send-button" id="sendButton">Send</button>
        <button id="testVoiceButton">ìŒì„± í…ŒìŠ¤íŠ¸</button>
        <button class="voice-button" id="voiceButton">ğŸ¤</button>
      </div>
    </div>
    {% else %}
    <div class="message received">ë¡œê·¸ì¸ì„ í•˜ì‹œë©´ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    {% endif %}
    <script>
      const chatBody = document.getElementById("chatBody");
      const messageInput = document.getElementById("messageInput");
      const sendButton = document.getElementById("sendButton");
      //ìŒì„±ë²„íŠ¼
      const voiceButton = document.getElementById("voiceButton");
      // WebSocket ì—°ê²° (Django ì„œë²„ ì£¼ì†Œì— ë§ê²Œ ìˆ˜ì •)
      // const socket = new WebSocket("ws://localhost:8000/ws/rp/");
      const socket = new WebSocket("ws://localhost:8000/ws/rp/");

      socket.onopen = function () {
        console.log("WebSocket ì—°ê²° ì„±ê³µ!");
      };

      socket.onmessage = function (event) {
        const data = JSON.parse(event.data);
        console.log("ì„œë²„ ì‘ë‹µ:", data);

        // ì„œë²„ë¡œë¶€í„° ë°›ì€ ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì°½ì— ì¶”ê°€
        const botResponse = document.createElement("div");
        botResponse.classList.add("message", "received");
        botResponse.textContent = data.message;
        chatBody.appendChild(botResponse);

        // ìŒì„± ì¶œë ¥
        if (data.audio_url) {
          const audio = new Audio(data.audio_url); // ì„œë²„ì—ì„œ ë°˜í™˜í•œ ìŒì„± íŒŒì¼ URL ì‚¬ìš©
          audio.play(); // ìŒì„± ì¬ìƒ
        }
        console.log(data.audio_url);

        // ìµœì‹  ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
        chatBody.scrollTop = chatBody.scrollHeight;
      };

      socket.onclose = function () {
        console.log("WebSocket ì—°ê²° ì¢…ë£Œë¨");
      };
      // ìŒì„±ë©”ì„¸ì§€
      voiceButton.addEventListener("click", function () {
        const recognition = new (window.SpeechRecognition ||
          window.webkitSpeechRecognition)();
        recognition.lang = "ko-KR"; // í•œêµ­ì–´ ì„¤ì •
        recognition.start(); // ìŒì„± ì¸ì‹ ì‹œì‘

        recognition.onresult = function (event) {
          const transcript = event.results[0][0].transcript;
          messageInput.value = transcript; // ì¸ì‹ëœ í…ìŠ¤íŠ¸ë¥¼ input ì°½ì— í‘œì‹œ
        };

        recognition.onerror = function (event) {
          console.error("ìŒì„± ì¸ì‹ ì˜¤ë¥˜:", event.error);
        };
      });

      sendButton.addEventListener("click", function () {
        const messageText = messageInput.value.trim();
        if (messageText) {
          // ì‚¬ìš©ìì˜ ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì— ì¶”ê°€
          const userMessage = document.createElement("div");
          userMessage.classList.add("message", "sent");
          userMessage.textContent = messageText;
          chatBody.appendChild(userMessage);

          // WebSocketì„ í†µí•´ ì„œë²„ì— ë©”ì‹œì§€ ì „ì†¡
          socket.send(JSON.stringify({ message: messageText }));

          // ë©”ì‹œì§€ ì…ë ¥ì°½ ì´ˆê¸°í™”
          messageInput.value = "";

          // ìµœì‹  ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
          chatBody.scrollTop = chatBody.scrollHeight;
        }
      });

      // Enter í‚¤ë¥¼ ëˆŒë €ì„ ë•Œë„ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆë„ë¡ ì¶”ê°€
      messageInput.addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          sendButton.click();
        }
      });
    </script>
  </body>
</html>
